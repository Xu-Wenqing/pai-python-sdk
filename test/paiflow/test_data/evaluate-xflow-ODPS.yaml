apiVersion: core/v1
metadata:
  provider: 1557702098194904
  identifier: evaluate-xflow-ODPS
  version: v1
spec:
  inputs:
    artifacts:
    - name: inputArtifact
      type: {DataSet: {locationType: MaxComputeTable}}
      required: true
    parameters: #形参
    - name: __xflowProject
      type: String
      required: true
      value: algo_public
    - name: __execution
      type: Map
      desc: "必选，执行环境"
    - name: outputDetailTableName
      type: String
      required: true
      desc: '输出用于画图的详细数据表'
    - name: outputELDetailTableName
      type: String
      required: true
      desc: '输出用于画EL图的详细数据表'
    - name: outputMetricTableName
      type: String
      required: true
      desc: '必选，输出的指标表，两列，指标名和指标值，包含AUC,KS,F1 Score三行'
    - name: lifecycle
      type: Int
      value: ""
      desc: '可选，输出表的生命周期'
    - name: coreNum
      type: Int
      value: 100
      desc: '核心数'
    - name: memSizePerCore
      type: Int
      value: 100
      desc: '单个节点内存大小，单位M'
    - name: positiveLabel
      type: String
      value: '1'
      desc: '可选，正样本的分类'
    - name: binCount
      type: Int
      value: 1000
      desc: '可选，计算KS，PR等指标时按等频分成多少个桶'
    - name: groupColName
      type: String
      value: ""
      desc: '可选，分组列的列名，用于分组评估场景'
    - name: detailColName
      type: String
      value: 'prediction_detail'
      desc: '可选，预测组件输出的detail列的列名'
    - name: scoreColName
      type: String
      required: true
      desc: '必选，score列的列名'
    - name: labelColName
      type: String
      required: true
      desc: '必选，目标列的列名'
  outputs:
    artifacts:
    - name: outputDetailArtifact
      type: {ModelEvaluation: {locationType: MaxComputeTable}}
      desc: '输出详细表'
    - name: outputELDetailArtifact
      type: {DataSet: {locationType: MaxComputeTable}}
      desc: '输出表'
    - name: outputMetricsArtifact
      type: {ModelEvaluation: {locationType: MaxComputeTable}}
      required: true
      desc: '输出指标表'
  #PAI -name evaluate -project algo_public -DlabelColName='_c2' -Dlifecycle='28' -DscoreColName='prediction_score' -DbinCount='1000' -DoutputDetailTableName='pai_temp_83935_1099589_2' -DpositiveLabel='1' -DoutputELDetailTableName='pai_temp_83935_1099589_3' -DdetailColName='prediction_detail' -DlabelMatch='true' -DoutputMetricTableName='pai_temp_83935_1099589_1' -DinputTableName='pai_temp_83935_1099588_1';
  execution:
    image: "registry.cn-shanghai.aliyuncs.com/kubeflow_demo/kf_odpscmd:studio0.6"
    command:
    - /usr/local/bin/start.sh
    args:
    - |-
      {
       "env": {
         "_PPC_MaxCompute": {{inputs.parameters.__execution}}
       },
       "args": {
         "inputTableName|location|table": "{{inputs.artifacts.inputArtifact.path}}",
         "inputTablePartitions|location|partition": "{{inputs.artifacts.inputArtifact.path}}",
         "__template": "pai_cmd",
         "__dropTables": ["{{inputs.parameters.outputDetailTableName}}","{{inputs.parameters.outputELDetailTableName}}","{{inputs.parameters.outputMetricTableName}}"],
         "__xflowName": "evaluate",
         "__xflowProject": "{{inputs.parameters.__xflowProject}}",
         "outputDetailTableName": "{{inputs.parameters.outputDetailTableName}}",
         "outputELDetailTableName": "{{inputs.parameters.outputELDetailTableName}}",
         "outputMetricTableName": "{{inputs.parameters.outputMetricTableName}}",
         "lifecycle": "{{inputs.parameters.lifecycle}}",
         "coreNum": "{{inputs.parameters.coreNum}}",
         "memSizePerCore": "{{inputs.parameters.memSizePerCore}}",
         "positiveLabel": "{{inputs.parameters.positiveLabel}}",
         "binCount": "{{inputs.parameters.binCount}}",
         "groupColName": "{{inputs.parameters.groupColName}}",
         "detailColName": "{{inputs.parameters.detailColName}}",
         "scoreColName": "{{inputs.parameters.scoreColName}}",
         "labelColName": "{{inputs.parameters.labelColName}}"
        },
       "outputs": {
         "{{outputs.artifacts.outputDetailArtifact.path}}": {"config": {"ModelEvaluationFormat": "BinaryClassificationEvaluationOutputIndicatorTable"}, "type": "ModelEvaluation", "location": {"type": "MaxComputeTable", "table": "{{inputs.parameters.outputDetailTableName}}"}},
         "{{outputs.artifacts.outputELDetailArtifact.path}}": {"config": {"ModelEvaluationFormat": "BinaryClassificationEvaluationOutputEqualFrequencyTable"}, "type": "ModelEvaluation", "location": {"type": "MaxComputeTable", "table": "{{inputs.parameters.outputELDetailTableName}}"}},
         "{{outputs.artifacts.outputMetricsArtifact.path}}": {"config": {"ModelEvaluationFormat": "BinaryClassificationEvaluationOutputEqualWidithTable"}, "type": "ModelEvaluation", "location": {"type": "MaxComputeTable", "table": "{{inputs.parameters.outputMetricTableName}}"}}
         }
      }