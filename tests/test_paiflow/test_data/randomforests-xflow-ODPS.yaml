apiVersion: core/v1
metadata:
  provider: 1557702098194904
  identifier: randomforests-xflow-ODPS
  version: v1
spec:
  inputs:
    artifacts:
    - name: inputArtifact
      type: {DataSet: {locationType: MaxComputeTable}}
      required: true
    parameters: #形参
    - name: __xflowProject
      type: String
      required: true
      value: algo_public
    - name: __execution
      type: Map
      desc: "必选，执行环境"
    - name: __userProject
      type: String
      required: false
      value: ""
    - name: labelColName
      type: String
      required: true
      desc: '输入表中标签列的列名'
      value: ""
    - name: modelName
      type: String
      required: true
      desc: '输出的模型名'
    - name: treeNum
      type: Int
      required: true
      desc: '森林中树的个数'
      feasible:
        Int: '(0,1000]'
    - name: weightColName
      type: String
      value: ""
      desc: '输入表中权重列的列名'
    - name: featureColNames
      type: String
      value: ""
      desc: '输入表中用于训练的特征的列名'
    - name: excludedColNames
      type: String
      value: ""
      desc: '用于反选特征列，该参数不可以与featureColNames并存'
    - name: forceCategorical
      type: String
      value: ""
      desc: 'feature默认解析规则：string、boolean、datetime类型的列解析为离散类型，double、bigint类型的列解析为连续类型 若有将bigint解析为categorical的情况，通过参数forceCategorical指定'
    - name: algorithmTypes
      type: String
      value: ""
      desc: '单颗树的算法在森林中的位置'
    - name: randomColNum
      type: Int
      value: ""
      desc: '单颗树在生成时，每次分裂时选择的随机的特征个数，范围[1-N]，其中N为feature个数，默认log2N'
      feasible:
        Int: '[1,INF)'
    - name: minNumObj
      type: Int
      desc: '叶节点数据的最小个数'
      value: 2
    - name: minNumPer
      type: Double
      desc: '叶节点数据个数占父节点的最小比例'
      value: 0.0
      feasible:
        Double: '[0,1]'
    - name: maxTreeDeep
      type: Int
      value: ""
      desc: '单颗树的最大深度'
      feasible:
        Int: '[1,INF)'
    - name: maxRecordSize
      type: Int
      desc: '森林中单颗树输入的随机数据的个数'
      value: 100000
      feasible:
        Int: '(1000,1000000]'
    - name: __generatePMML
      type: Bool
      value: false
    - name: __pmmlModelPublicProject
      type: String
      required: false
      value: ""
    - name: __pmmlModelPublicEndpoint
      type: String
      required: false
      value: ""
    - name: __pmmlModelVolume
      type: String
      required: false
      value: ""
    - name: __pmmlModelPartition
      type: String
      value: ""
      required: false
    - name: __modelPartition
      type: String
      value: ""
      required: false
  outputs:
    artifacts:
    - name: outputArtifact
      type: {Model: {locationType: MaxComputeOfflineModel, modelType: OfflineModel}}
    - name: pmmlArtifact
      type: {Model: {locationType: MaxComputeVolume, modelType: PMML}}
  #PAI -name randomforests -project algo_public -DlabelColName='_c2' -DminNumPer='0' -DtreeNum='100' -DmodelName='xlab_m_random_forests_1099584_v0' -DminNumObj='2' -DmaxRecordSize='10000' -DinputTableName='pai_temp_83935_1099583_1' -DfeatureColNames='pm10,so2,co,no2';
  execution:
    image: "registry.cn-shanghai.aliyuncs.com/kubeflow_demo/kf_odpscmd:studio0.6"
    command:
    - /usr/local/bin/start.sh
    args:
    - |-
      {
       "env": {
         "_PPC_MaxCompute": {{inputs.parameters.__execution}}
       },
       "args": {
         "inputTableName|location|table": "{{inputs.artifacts.inputArtifact.path}}",
         "__template": "pai_cmd",
         "__deleteModels": ["{{inputs.parameters.modelName}}"],
         "__xflowName": "randomforests",
         "__xflowProject": "{{inputs.parameters.__xflowProject}}",
         "modelName": "{{inputs.parameters.modelName}}",
         "labelColName": "{{inputs.parameters.labelColName}}",
         "treeNum": "{{inputs.parameters.treeNum}}",
         "weightColName": "{{inputs.parameters.weightColName}}",
        "featureColNames": "{{inputs.parameters.featureColNames}}",
        "excludedColNames": "{{inputs.parameters.excludedColNames}}",
        "forceCategorical": "{{inputs.parameters.forceCategorical}}",
        "algorithmTypes": "{{inputs.parameters.algorithmTypes}}",
        "randomColNum": "{{inputs.parameters.randomColNum}}",
        "minNumObj": "{{inputs.parameters.minNumObj}}",
        "minNumPer": "{{inputs.parameters.minNumPer}}",
        "maxTreeDeep": "{{inputs.parameters.maxTreeDeep}}",
        "maxRecordSize": "{{inputs.parameters.maxRecordSize}}",
        "__generatePMML": "{{inputs.parameters.__generatePMML}}",
         "__pmmlModelPublicProject": "{{inputs.parameters.__pmmlModelPublicProject}}",
         "__pmmlModelPublicEndpoint": "{{inputs.parameters.__pmmlModelPublicEndpoint}}",
         "__pmmlModelVolume": "{{inputs.parameters.__pmmlModelVolume}}",
         "__pmmlModelPartition": "{{inputs.parameters.__pmmlModelPartition}}",
         "__modelPartition": "{{inputs.parameters.__modelPartition}}",
         "__userProject": "{{inputs.parameters.__userProject}}"
        },
       "outputs": {
        "{{outputs.artifacts.outputArtifact.path}}": {"type": "Model", "location": {"type": "MaxComputeOfflineModel", "name": "{{inputs.parameters.modelName}}"}, "config": {"modelName": "{{inputs.parameters.modelName}}", "modelFormat": "OfflineModel"}},
        "{{outputs.artifacts.pmmlArtifact.path}}": {"type": "Model", "location": {"type": "MaxComputeVolume", "volume": "{{inputs.parameters.__pmmlModelPublicProject}}/volumes/{{inputs.parameters.__pmmlModelVolume}}", "volumePartiton": "{{args.__pmmlModelPartition}}"}, "config": {"modelName": "{{inputs.parameters.__userProject}}/offlinemodels/{{inputs.parameters.modelName}}", "modelFormat": "PMML"}}
         }
      }